<!DOCTYPE html>
<html>
<head>
    <title>Monetary Incentive Delay Task</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="/jspsych-6.0.4/css/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
        #results-wr {
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div id="results"></div>
</body>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

<script src="/jspsych-6.0.4/jspsych.js"></script>
<script src="/jspsych-6.0.4/plugins/jspsych-html-keyboard-response.js"></script>
<script src="/display/graph.js"></script>
<script src="/staircase/staircase.js"></script>
<script>
    function jitterTime(){
        return jsPsych.randomization.sampleWithoutReplacement([500, 1250, 2000], 1)[0]
    }

    var numTrials = 6;
    var results = {};

    var staircase = new Staircase({
        firstVal: 400,
        down: 2,
        factor: 1.4,
        operation: 'multiply',
        limits: [0, 600],
        verbosity: 1
    });

    var timeline = [];
    var instructions = {
      type: "html-keyboard-response",
      stimulus: "<p>This block will consist of 25 trials.</p>" +
        "<p>The fixation will appear followed by the target. Try to press the ENTER key as quickly as possible while the target is displayed." +
        "<p></p><p>Press any key to begin.</p>"
    }
    
    timeline.push(instructions)
	
	var fixation = {
        type: 'html-keyboard-response',
        myvar: 'fixation',
        stimulus: '<div style="font-size:60px;">+</div>',
        choices: jsPsych.NO_KEYS,
        trial_duration: function() { return jitterTime(); }
    }
    
    var test = {
        type: "html-keyboard-response",
        stimulus: '<div style="display: block; height: 80px; width: 80px; background: #666; border-radius: 50%;"></div>',
        trial_duration: function() { return staircase.getValue() },
        choices: ['Enter', 'Space'],
        data: {
            target: true
        },
        on_finish: function(data) {
            data.presentation_duration = staircase.getValue();
            var hit = data.rt ? true : false;
            data.hit = hit;
            staircase.addResponse(hit);
        }
    }
    
    var feedback = {
    	type: "html-keyboard-response",
    	stimulus: function(){
            var targetData = JSON.parse(
                jsPsych.data.getLastTimelineData().filter({target: true}).json()
                ).pop();

    		var msg = targetData.hit ? 'You Win!!!' : 'Sorry. You Lose.';
    		return '<p>' + msg + '</p>';
      },
      trial_duration: function() { return jitterTime(); }
    }
    
	var test_procedure = {
        timeline: [fixation, test, fixation, feedback],
        repetitions: numTrials
    }
    timeline.push(test_procedure)

    
    jsPsych.init({
          timeline: timeline,
          on_finish: function() {
              results.trials = JSON.parse(
                jsPsych.data.get().filter({target: true}).json()
              );
                
              processResults();
              displayResults();
          }
    })

    function processResults() {
        var numHits = 0;
        var numMisses = 0;
        results.dataPoints = [];
        
        results.trials.forEach( function(trial) {
          delete trial.stimulus;
          var datapoint = {
            x: trial.time_elapsed / 1000,
            y: trial.presentation_duration,
          };

          if (trial.hit) {
            datapoint.markerColor = 'green';
            datapoint.markerType = 'triangle';
            numHits++;
          }
          else {
            datapoint.markerColor = 'red';
            datapoint.markerType = 'cross';
            numMisses++;
          }
          results.dataPoints.push(datapoint);
        });

        results.numHits = numHits;
        results.numMisses = numMisses;

        results.successRate = numHits / (numHits + numMisses);
    }


    function displayResults() {
        $('.jspsych-content-wrapper').remove();
        var resultsHtml = $('<div id="results-wr" class="container"><h1>Results:</h1></div>');
        resultsHtml.append(`<p>You scored ${results.successRate * 100} %<p><hr><hr>`);
        
        resultsHtml.append('<div id="theGraph" style="height: 450px;"></div>');
        resultsHtml.append('<hr><hr>');
        $('body').append(resultsHtml);

        drawSampleChart(results);
        resultsHtml.append(prettyPrint(results));

    }

    function prettyPrint(obj) {
        var dataString = JSON.stringify(obj, null, 3);
        var styles = 'font-size: 0.7rem; background: #eee; border: 1px solid #aaa;'
        return `<pre style="${styles}">${dataString}</pre>`;
    }

</script>
</html>